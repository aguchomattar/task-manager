name: Build, Push, and Update GitOps Config

on:
  push:
    branches: [ main ]

jobs:
  # ===============================================
  # 1. BUILD Y PUSH DEL BACKEND
  # ===============================================
  build-push-backend:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ github.sha }} 
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend # Usa la carpeta del backend
          push: true
          tags: agucho/task-manager-backend:v${{ github.run_number }} 

  # ===============================================
  # 2. BUILD Y PUSH DEL FRONTEND
  # ===============================================
  build-push-frontend:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ github.sha }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend # Usa la carpeta del frontend
          push: true
          tags: agucho/task-manager-frontend:v${{ github.run_number }} 

  # ===============================================
  # 3. ACTUALIZAR CONFIGURACIÓN DEL BACKEND EN GITOPS
  # ===============================================
  update-backend-config:
    runs-on: ubuntu-latest
    needs: build-push-backend 
    steps:
      - name: Checkout Repositorio GitOps
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITOPS_REPO_TOKEN }} 
          repository: aguchomattar/argocd-gitops 
          path: argocd-config 

      - name: Instalar yq
        run: sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && sudo chmod +x /usr/bin/yq

      - name: Actualizar Tag del Backend
        run: |
          cd argocd-config
          NEW_TAG=v${{ github.run_number }}
          APP_FILE="apps/dev/task-manager-backend-dev.yaml" 
          
          yq -i ".spec.source.helm.values.image.tag = \"$NEW_TAG\"" $APP_FILE
          echo "Backend config updated."

  # ===============================================
  # 4. ACTUALIZAR CONFIGURACIÓN DEL FRONTEND EN GITOPS
  # ===============================================
  update-frontend-config:
    runs-on: ubuntu-latest
    needs: build-push-frontend
    steps:
      - name: Checkout Repositorio GitOps
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          repository: aguchomattar/argocd-gitops 
          path: argocd-config

      - name: Instalar yq
        run: sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && sudo chmod +x /usr/bin/yq

      - name: Actualizar Tag del Frontend
        run: |
          cd argocd-config
          NEW_TAG=v${{ github.run_number }}
          APP_FILE="apps/dev/task-manager-frontend-dev.yaml" 
          
          yq -i ".spec.source.helm.values.image.tag = \"$NEW_TAG\"" $APP_FILE
          echo "Frontend config updated."
          
  # ===============================================
  # 5. COMMIT Y PUSH AL REPO GITOPS
  # ===============================================
  commit-and-push-gitops:
    runs-on: ubuntu-latest
    needs: [update-backend-config, update-frontend-config] 
    steps:
      - name: Checkout Repositorio GitOps (Para Commit)
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          repository: aguchomattar/argocd-gitops 
          path: argocd-config
          
      - name: Configuración Git
        run: |
          cd argocd-config
          git config --global user.name "CI Bot"
          git config --global user.email "ci-bot@github.com"
          
      - name: Commit y Push de los cambios
        run: |
          cd argocd-config
          git add .
          git commit -m "CI-CD: Actualiza tags de Frontend y Backend a v${{ github.run_number }}"
          git push