name: Build, Push, and Update GitOps Config

on:
  push:
    branches: [ main ]

env:
  DOCKERHUB_USERNAME: agucho
  GITOPS_REPO: aguchomattar/argocd-gitops

jobs:
  # ===============================================
  # 1. BUILD Y PUSH DE AMBAS IM√ÅGENES
  # ===============================================
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Version
        id: set-version
        run: echo "version=v${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/task-manager-backend:${{ steps.set-version.outputs.version }}
            ${{ env.DOCKERHUB_USERNAME }}/task-manager-backend:latest

      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/task-manager-frontend:${{ steps.set-version.outputs.version }}
            ${{ env.DOCKERHUB_USERNAME }}/task-manager-frontend:latest

  # ===============================================
  # 2. ACTUALIZAR GITOPS REPO
  # ===============================================
  update-gitops:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout GitOps Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          repository: ${{ env.GITOPS_REPO }}
          ref: main

      - name: Update Image Tags
        env:
          NEW_VERSION: ${{ needs.build-and-push.outputs.version }}
        run: |
          echo "üîÑ Actualizando tags a $NEW_VERSION..."
          
          # Backend
          BACKEND_FILE="apps/dev/task-manager-backend-dev.yaml"
          if [ -f "$BACKEND_FILE" ]; then
            sed -i "s|tag: \"v[0-9]*\"|tag: \"$NEW_VERSION\"|g" $BACKEND_FILE
            echo "‚úÖ Backend actualizado"
          else
            echo "‚ùå ERROR: $BACKEND_FILE no encontrado"
            exit 1
          fi
          
          # Frontend
          FRONTEND_FILE="apps/dev/task-manager-frontend-dev.yaml"
          if [ -f "$FRONTEND_FILE" ]; then
            sed -i "s|tag: \"v[0-9]*\"|tag: \"$NEW_VERSION\"|g" $FRONTEND_FILE
            echo "‚úÖ Frontend actualizado"
          else
            echo "‚ùå ERROR: $FRONTEND_FILE no encontrado"
            exit 1
          fi
          
          echo ""
          echo "üìÑ Archivos actualizados:"
          echo "--- Backend ---"
          grep "tag:" $BACKEND_FILE
          echo "--- Frontend ---"
          grep "tag:" $FRONTEND_FILE

      - name: Commit and Push Changes
        env:
          NEW_VERSION: ${{ needs.build-and-push.outputs.version }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add apps/dev/
          
          # Verificar si hay cambios
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  No hay cambios para commitear"
            exit 0
          fi
          
          # Commit y push
          git commit -m " Update image tag to $NEW_VERSION

          - Backend: ${{ env.DOCKERHUB_USERNAME }}/task-manager-backend:$NEW_VERSION
          - Frontend: ${{ env.DOCKERHUB_USERNAME }}/task-manager-frontend:$NEW_VERSION
          
          Triggered by: ${{ github.actor }}
          Commit: ${{ github.sha }}"
          
          git push origin main
          
          echo ""
          echo "‚úÖ Cambios pusheados exitosamente!"
          echo "üîó Ver en: https://github.com/${{ env.GITOPS_REPO }}/commit/$(git rev-parse HEAD)"